#!/bin/bash
#! /bin/bash

# é¡è‰²è¨­å®š
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
WHITE="\033[0m"

package_check() {
    local cmd=$1
    local pkg=${2:-$1}  # Use second parameter as package name, or default to command name
    
    if ! command -v ${cmd} 1>/dev/null; then
        read -r -e -p "æœ¬è…³æœ¬éœ€è¦å®‰è£ ${cmd}ï¼Œè«‹ç¢ºèªæ˜¯å¦å®‰è£ä¸¦ç¹¼çºŒåŸ·è¡Œï¼Ÿ(Y/N)ï¼š" continue
        case $continue in
            Y | y)
                brew install ${pkg} ;;
            N | n)
                echo -e "${RED}æœªå®‰è£ ${cmd}ï¼Œé€€å‡ºè…³æœ¬${WHITE}"
                exit 1 ;;
            *)
                echo -e "${RED}ç„¡æ•ˆåƒæ•¸ ($REPLY)ï¼Œè«‹é‡æ–°è¼¸å…¥${WHITE}"
                exit 1 ;;
        esac
    fi
}

commands=("kubectl" "fzf")
packages=("kubectl" "fzf")

for i in "${!commands[@]}"; do
    cmd="${commands[$i]}"
    pkg="${packages[$i]}"
    package_check "${cmd}" "${pkg}"
done

# é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
show_help() {
    echo -e "${BLUE}ktx - Kubernetes Context åˆ‡æ›å·¥å…·${NC}"
    echo "ç”¨æ³•:"
    echo "  ktx                   - äº’å‹•å¼é¸æ“‡ä¸¦åˆ‡æ› Kubernetes Context"
    echo "  ktx <context-name>    - ç›´æ¥åˆ‡æ›åˆ°æŒ‡å®šçš„ Context"
    echo "  ktx -l, --list        - åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ Context"
    echo "  ktx -c, --current     - é¡¯ç¤ºç•¶å‰ä½¿ç”¨çš„ Context"
    echo "  ktx -h, --help        - é¡¯ç¤ºæ­¤å¹«åŠ©è¨Šæ¯"
}

# ç²å–æ‰€æœ‰å¯ç”¨çš„ Context
ktx_contexts() {
    kubectl config get-contexts -o name
}

# ç²å–ç•¶å‰ Context
ktx_current_context() {
    kubectl config current-context
}

# ä¸»å‡½æ•¸
ktx() {
    # è™•ç†å‘½ä»¤è¡Œåƒæ•¸
    case "$1" in
        "-h"|"--help")
            show_help
            return 0
            ;;
        "-l"|"--list")
            echo -e "${BLUE}å¯ç”¨çš„ Kubernetes Contexts:${NC}"
            contexts=$(ktx_contexts)
            current=$(ktx_current_context)
            echo "$contexts" | while read -r ctx; do
                if [ "$ctx" = "$current" ]; then
                    echo -e "${GREEN}* $ctx${NC}"
                else
                    echo "$ctx"
                fi
            done
            return 0
            ;;
        "-c"|"--current")
            current=$(ktx_current_context)
            echo -e "ç•¶å‰ Context: ${GREEN}$current${NC}"
            return 0
            ;;
        "")
            # ç„¡åƒæ•¸æ™‚åŸ·è¡Œäº’å‹•å¼é¸æ“‡
            contexts=$(ktx_contexts)
            current=$(ktx_current_context)
            
            # ä½¿ç”¨ fzf è®“ç”¨æˆ¶é¸æ“‡ Context
            # é å…ˆé¸ä¸­ç•¶å‰ Context
            context=$(echo "$contexts" | fzf --prompt="ğŸ‘† è«‹é¸æ“‡ kubeContextï¼š")
            
            if [ -z "$context" ]; then
                echo -e "${RED}æœªé¸æ“‡ kubeContextï¼Œæ“ä½œå–æ¶ˆ${NC}"
                return 1
            fi
            
            # å¦‚æœé¸æ“‡çš„ Context èˆ‡ç•¶å‰ç›¸åŒï¼Œå‰‡ä¸åšä»»ä½•æ“ä½œ
            if [ "$context" = "$current" ]; then
                echo -e "${YELLOW}å·²ç¶“åœ¨ä½¿ç”¨ Context: $context${NC}"
                return 0
            fi
            
            # åˆ‡æ›åˆ°é¸ä¸­çš„ Context
            kubectl config use-context "$context"
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}å·²åˆ‡æ›åˆ° Context: $context${NC}"
            else
                echo -e "${RED}åˆ‡æ›å¤±æ•—${NC}"
                return 1
            fi
            ;;
        *)
            # ç›´æ¥åˆ‡æ›åˆ°æŒ‡å®šçš„ Context
            specified_context="$1"
            
            # æª¢æŸ¥æŒ‡å®šçš„ Context æ˜¯å¦å­˜åœ¨
            if ! kubectl config get-contexts "$specified_context" &>/dev/null; then
                echo -e "${RED}éŒ¯èª¤: Context '$specified_context' ä¸å­˜åœ¨${NC}"
                echo "å¯ç”¨çš„ Contexts:"
                ktx_contexts
                return 1
            fi
            
            # åˆ‡æ› Context
            kubectl config use-context "$specified_context"
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}å·²åˆ‡æ›åˆ° Context: $specified_context${NC}"
            else
                echo -e "${RED}åˆ‡æ›å¤±æ•—${NC}"
                return 1
            fi
            ;;
    esac
}

# å¦‚æœç›´æ¥åŸ·è¡Œæ­¤è…³æœ¬ï¼Œå‰‡èª¿ç”¨ ktx å‡½æ•¸
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    ktx "$@"
fi